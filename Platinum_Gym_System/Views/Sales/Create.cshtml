@model Platinum_Gym_System.ViewModels.SaleCreateVM

<h2>Crear Venta</h2>

<form asp-action="Create" method="post" id="saleForm">

    <div class="mb-3">
        <label asp-for="Sale.SaleDate"></label>
        <input asp-for="Sale.SaleDate" class="form-control" />
    </div>

    <div class="mb-3">
        <label asp-for="Sale.PaymentId"></label>
        <select asp-for="Sale.PaymentId" class="form-control" asp-items="ViewBag.PaymentId"></select>
    </div>

    <hr />
    <h4>Productos de la Venta</h4>

    <table class="table" id="DetalleTable">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button type="button" class="btn btn-success" onclick="AgregarDetalle()">Agregar Producto</button>

    <h3>Total: $<span id="TotalDisplay">0.00</span></h3>

    <input type="hidden" name="Sale.Total" id="TotalHidden" />

    <br />
    <button type="submit" class="btn btn-primary">Guardar Venta</button>
</form>

@section Scripts {
    <script>

        // Obtener productos desde backend (con precio)
        var productos = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Products));

        function AgregarDetalle() {

            var index = $("#DetalleTable tbody tr").length;
            var precioInicial = productos[0].price;

            var fila = `
            <tr>
                <td>
                    <select name="Items[${index}].ProductId" class="form-control" onchange="ActualizarFila(this)">
                        ${productos.map(p => `<option value="${p.productId}" data-price="${p.price}">${p.productName}</option>`).join("")}
                    </select>
                </td>

                <td>
                    <input class="form-control price" value="${precioInicial.toFixed(2)}" readonly />
                </td>

                <td>
                    <input type="number"
                           name="Items[${index}].Quantity"
                           class="form-control qty"
                           value="1" min="1"
                           onchange="ActualizarFila(this)" />
                </td>

                <td>
                    <input class="form-control subtotal" value="${precioInicial.toFixed(2)}" readonly />
                    <input type="hidden"
                           name="Items[${index}].Subtotal"
                           value="${precioInicial.toFixed(2)}"
                           class="subtotalHidden" />
                </td>

                <td>
                    <button type="button" class="btn btn-danger" onclick="EliminarFila(this)">X</button>
                </td>
            </tr>`;

            $("#DetalleTable tbody").append(fila);
            CalcularTotal();
        }

        function ActualizarFila(control) {
            var fila = $(control).closest("tr");

            var precio = parseFloat(fila.find("select option:selected").data("price"));
            var cantidad = parseInt(fila.find(".qty").val());
            var subtotal = precio * cantidad;

            fila.find(".price").val(precio.toFixed(2));
            fila.find(".subtotal").val(subtotal.toFixed(2));
            fila.find(".subtotalHidden").val(subtotal.toFixed(2));

            CalcularTotal();
        }


        function EliminarFila(btn) {
            $(btn).closest("tr").remove();
            ReindexarFilas();
            CalcularTotal();
        }

        // 🔥 Corrige los nombres antes del envío
        function ReindexarFilas() {
            $("#DetalleTable tbody tr").each(function (i, row) {
                $(row).find("select, input[name]").each(function () {
                    let name = $(this).attr("name");

                    if (name) {
                        let newName = name.replace(/Items\[\d+\]/, `Items[${i}]`);
                        $(this).attr("name", newName);
                    }
                });
            });
        }


        function CalcularTotal() {
            var total = 0;
            $(".subtotal").each(function () {
                total += parseFloat($(this).val()) || 0;
            });

            $("#TotalDisplay").text(total.toFixed(2));
            $("#TotalHidden").val(total.toFixed(2));
        }

        // 🔥 Antes de enviar, hacer reindexación y recalcular total
        $("#saleForm").submit(function () {
            ReindexarFilas();
            CalcularTotal();
        });

    </script>

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
